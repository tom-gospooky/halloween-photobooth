#!/usr/bin/env node

import dotenv from 'dotenv';
import fs from 'fs';
import path from 'path';
import { PhotoAnalysisService } from '../src/services/photoAnalysisService.js';
import { VideoGenerationService } from '../src/services/videoGenerationService.js';
import { GeminiErrorHandler } from '../src/utils/geminiErrorHandler.js';

// Load environment variables
dotenv.config();

const TEST_IMAGE_PATH = './test/foto_1.jpg';

async function checkTestImage() {
  // Use real Halloween image from /test folder
  if (!fs.existsSync(TEST_IMAGE_PATH)) {
    console.log('âŒ Test image not found:', TEST_IMAGE_PATH);
    console.log('Expected: foto_1.jpg in /test folder');
    throw new Error('Test image missing');
  } else {
    const stats = fs.statSync(TEST_IMAGE_PATH);
    console.log('âœ… Using real Halloween party photo from /test folder');
    console.log(`ðŸ“Š Image size: ${Math.round(stats.size / 1024)}KB`);
  }
}

async function testGeminiVideoPrompt() {
  console.log('\nðŸ“ Testing Gemini 2.5 Flash Video Prompt Generation...');

  try {
    const photoAnalysis = new PhotoAnalysisService();
    const videoPrompt = await photoAnalysis.generateVideoPrompt(TEST_IMAGE_PATH);

    console.log('âœ… Video prompt generated by Gemini 2.5 Flash:');
    console.log('  ðŸ“„ Length:', videoPrompt.length, 'characters');
    console.log('  ðŸ“œ Content preview:', videoPrompt.substring(0, 150) + '...');

    return videoPrompt;

  } catch (error) {
    console.error('âŒ Gemini video prompt generation failed:', error.message);

    const fallbackPrompt = process.env.MASTER_PROMPT ||
      "Transform this Halloween photo into a spooky scene with supernatural elements. Duration: 8 seconds.";
    console.log('ðŸ”„ Using fallback prompt');

    return fallbackPrompt;
  }
}

async function testMasterPrompt() {
  console.log('\nðŸŽ­ Testing Master Prompt Configuration...');

  try {
    const photoAnalysis = new PhotoAnalysisService();
    const masterPrompt = photoAnalysis.getMasterPrompt();

    console.log('âœ… Master prompt loaded successfully');
    console.log('  ðŸ“„ Length:', masterPrompt.length, 'characters');
    console.log('  ðŸ“œ Source: See console output above for specific source');

    if (masterPrompt.length > 500) {
      console.log('  ðŸ“‹ Complex prompt detected - likely from master.md');
    } else {
      console.log('  ðŸ“ Simple prompt - likely from env var or default');
    }

    return masterPrompt;

  } catch (error) {
    console.error('âŒ Master prompt check failed:', error.message);
    return null;
  }
}


async function testVideoGeneration(geminiOutputText, imagePath) {
  console.log('\nðŸŽ¬ Testing WAN 2.2 Turbo Video Generation...');

  try {
    const videoGeneration = new VideoGenerationService();
    const videoPath = await videoGeneration.generateVideo(geminiOutputText, imagePath, 'test-photo.jpg');
    
    console.log('âœ… Video generation completed:', path.basename(videoPath));
    
    // Check if file exists and has reasonable size
    if (fs.existsSync(videoPath)) {
      const stats = fs.statSync(videoPath);
      console.log('  ðŸ“ File size:', Math.round(stats.size / 1024), 'KB');
      
      if (stats.size > 1000) { // At least 1KB
        console.log('  âœ… Video file appears valid');
      } else {
        console.log('  âš ï¸  Video file seems small (might be placeholder)');
      }
    }
    
    return videoPath;
    
  } catch (error) {
    console.error('âŒ WAN video generation failed:', error.message);
    console.log('ðŸ”„ This would trigger placeholder fallback in production');
    return null;
  }
}

async function testErrorHandling() {
  console.log('\nðŸ›¡ï¸  Testing Error Handling...');
  
  const errorHandler = new GeminiErrorHandler();
  
  // Test different error types
  const testErrors = [
    { message: 'rate limit exceeded', status: 429 },
    { message: 'api key invalid', status: 401 },
    { message: 'content filtered by safety', status: 400 },
    { message: 'network timeout', code: 'ECONNRESET' }
  ];
  
  for (const testError of testErrors) {
    const errorInfo = errorHandler.parseGeminiError(testError);
    console.log(`  ðŸ“‹ Error type "${testError.message}": ${errorInfo.type}`);
  }
  
  console.log('âœ… Error handling patterns identified correctly');
}

async function runFullWorkflowTest() {
  console.log('ðŸŽƒ Halloween AI Photobooth - Workflow Test\n');
  
  try {
    // Ensure temp directory exists
    if (!fs.existsSync('./temp')) {
      fs.mkdirSync('./temp');
    }
    
    // Test each component - new simplified 2-step workflow
    await checkTestImage();
    await testMasterPrompt();
    const geminiVideoPrompt = await testGeminiVideoPrompt();
    const videoPath = await testVideoGeneration(geminiVideoPrompt, TEST_IMAGE_PATH);
    await testErrorHandling();
    
    console.log('\nðŸŽ‰ Simplified 2-Step Workflow Test Summary:');
    console.log('âœ… Step 1: Gemini 2.5 Flash + master.md â†’ Video prompt generation');
    console.log('âœ… Step 2: WAN 2.2 Turbo + Gemini output + Image â†’ Video generation');
    console.log('âœ… Master Prompt: Priority: master.md â†’ MASTER_PROMPT â†’ default');
    console.log('âœ… Error Handling: Robust with fallbacks');
    
    console.log('\nðŸ“‹ Next Steps:');
    console.log('1. Add your real Gemini API key to .env (âœ… Done)');
    console.log('2. Add your FAL_KEY to .env (âœ… Done)');
    console.log('3. Edit master.md to customize sophisticated film direction prompts');
    console.log('4. Test workflow: Image + master.md â†’ Gemini 2.5 â†’ WAN 2.2 Turbo');
    console.log('5. Run the full system with: npm run dev');
    
    // Cleanup test files (optional)
    const cleanup = process.argv.includes('--cleanup');
    if (cleanup) {
      console.log('\nðŸ§¹ Cleaning up test files...');
      [TEST_IMAGE_PATH, videoPath].forEach(filePath => {
        if (filePath && fs.existsSync(filePath)) {
          fs.unlinkSync(filePath);
          console.log('  ðŸ—‘ï¸  Deleted:', path.basename(filePath));
        }
      });
    }
    
  } catch (error) {
    console.error('âŒ Workflow test failed:', error);
    process.exit(1);
  }
}

// Run the test if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  runFullWorkflowTest()
    .then(() => process.exit(0))
    .catch(error => {
      console.error('Test failed:', error);
      process.exit(1);
    });
}